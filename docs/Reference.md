API and Usage Reference
=======================

Functions
---------

#### `createInstance([config])`
Returns a new instance of Scurvy with config options applied if specified. Synchronous.

#### config object fields:
- `showTrace` - Enables internal trace logging to console.log. A boolean value for debug and development purposes. Defaults to `false`.
<p></p>
- `authSchema` - Choose a standard method of login. When this String value is changed in an existing installation, the assumed table structure will change -- resulting in the need to alter or drop/recreate tables. It is suggested to pick the one that suits you best and stick with your choice.
`authSchema` can be set to one of the following modes:
  - `'userid'` - Uses a userid field as the login name. Also includes an email address field. Default value.
  - `'email'` - Uses the user's email address as the login name.

#### `loadModels(hook)`
Loads all scurvy models into the provided `hook` object. Call this once after initializing a scurvy instance. The provided `hook` object must contain a field `sequelize` which is an instantiation of a `new Sequelize(...)` object. Synchronous.

#### `setupAssociations(hook)`
Sets up the primary-key/foreign-key relationships of the scurvy models. Call this once after calling the above `loadModels()` with the same `hook`. Synchronous.

#### `setupSync(hook, callback, [syncParams])`
Creates the `User` and `Metastate` tables if they don't already exist. Call this once after calling the above `setupAssociations()` with the same `hook`. The `callback` is called after completion with method signature `callback(err, successful)`, where `successful` is `true` when the operation completed successfully. `syncParams` is an optional parameter passed in to the Sequelize table creation `.sync()` function. See http://sequelizejs.com/documentation#models-database-synchronization . Asynchronous.

#### `generateNewHash(input, callback)`
Creates a 60 character hash and 29 character salt from ```input```. Calls ```callback``` when complete with method signature ```function (err, result)```. ```err``` is null when there is no error. ```result``` is an object with two fields ```salt``` and ```hash``` that are created by the hashing algorithm.  Asynchronous.

#### `comparePlaintextToHash(inputPassword, hash, callback)`
Takes an ```inputPassword``` and  ```hash``` that was created with generateNewHash() (where inputPassword was the input) and returns a ```callback``` with method signature ```function(err, matches)``` where ```err``` is null when there is no error, and ```matches``` is true if the parameters validate. Asynchronous.

#### `setRounds(rounds)`
Optional function. Internally, rounds defaults to 10.
`rounds` must be an integer > 0. Synchronous.

#### `generateMetastateHashkey(email, salt, callback)`
Generates a metastate hash based off of the provided ```email``` and ```salt```. The salt is intended to be the same which hashes the user's password.
The resultant hashkey is passed to the callback with method signature ```callback(err, result)``` and can be used for an account confirmation URL (or other ways of identifying the account with a hash).
If ```err``` is null, the ```result``` object will include a field: ```hashkey```. Asynchronous.

#### `doesMetastateHashkeyHaveUser(hashkey, callback)`
Checks the database to see if a `User` with a `status` of `inactive` exists for a given `hashkey`.
The `callback` is fired when the query is complete with method signature `callback(err, result)` where `result` is false if the match does not exist, otherwise it will be an object with fields containing the sequelize objects of the found user: `{ user: user, metastate: metastate }`. Asynchronous.

#### `validateMetastateHashkey(hashkey, email, callback)`
Checks to see if a given ```hashkey``` was generated by a particular ```email```.
If the hashkey was generated by the email, the ```callback(err, validates)``` will have a null ```err``` and ```validates``` will be true. Else, ```validates``` will be false. Asynchronous.

#### `createUser(params, callback)`
Creates a user with given ```params```. Required fields for ```params``` include: ```userid```, ```email```, ```passwrd```, and ```status```. If `authSchema` is set to `email`, do not pass the `userid` field as it is not used in this configuration.
```status``` must be either ```'active'```, ```'inactive'```, or ```'deleted'```. If left blank, ```status``` will default to ```inactive```.
Upon completion, ```callback``` will be called with method signature ```callback(err, result)``` where result will be an object containing sequelize object references to the newly created  ```user``` and ```metastate``` if ```err``` is null. Asynchronous.

#### `activateUser(input, callback)`
Takes a sequelize object reference of a User instance that has a property `input.metastate` and sets the `status` property to `active`.
The callback function is fired with method signature `callback(err, successful)`, and `successful` is true when the user was successfully updated. Asynchronous.

#### 'verifyCredentials(credentials, callback)`
Checks the database to see if the given `credentials` are valid for an existing user, and returns the user. The `credentials` object requires different parameters depending on the configuration -- if `authSchema` is set to `userid`, pass in the object like: `{ userid 'theuserid', passwrd: 'thepassword' }` and if `authSchema` is set to `email`, pass in the object like: `{ email 'theemail@domain.com', passwrd: 'thepassword' }`. The `callback` is called with method signature `callback(err, user)` where the `user` will be a valid retrieved `User` object if the `credentials` are valid, else it will be `false`.


Usage Without Database Features
-------------------------------

This is a simple example that does not require use of any database:

```
var scurvy = require('scurvy').createInstance();

var my_secure_password = 'password01'; //uber secure

var salt = "";
var hashed_password = "";
var validated = false;

function main() {
	hashPassword(function() {
		validate_credentials(function() {
			console.log("Does it match? " + validated);
		});
	});
}

function hashPassword(callback) {
	//Generate a salt and hash from a password.
	scurvy.generateNewHash(my_secure_password, function (err, result) {
		salt = result.salt;
		hashed_password = result.hash;
		callback();
	});
}

function validate_credentials(callback) {
	scurvy.comparePlaintextToHash(my_secure_password, hash, function(err, matches) {
		validated = matches;
		callback();
	});
}

```


Usage With Database Features
------------------------------------------

Scurvy has the option to take advantage of the powerful features of sequelizejs (http://sequelizejs.com) to manage persistence of user information in a database. As of right now, only mysql has been tested, but probably can be used with other databases supported by sequelize, with slight modification.

It is suggested to follow a convention of encapsulation when using database features with scurvy.
So for example, we have the following files in our project:

```
/lib/models/index.js
```
Inside we have:
```
var Sequelize = require('sequelize');

//console.log("process.env.NODE_ENV: [" + process.env.NODE_ENV + "]");

var database_config_to_use = '';
switch (process.env.NODE_ENV) {
    case 'test_travis':
        database_config_to_use = '../../config/database.test_travis';
        break;
    case undefined:
    case 'production':
    case 'development':
        database_config_to_use = '../../config/database';
        break;
}
var dbconfig = require(database_config_to_use).config;

var dbname = dbconfig.db;
var dbhostname = dbconfig.hostname;
var dbport = dbconfig.port;
var dbuser = dbconfig.user;
var dbpassword = dbconfig.password;

var sequelize = new Sequelize(dbname, dbuser, dbpassword, {
    host: dbhostname,
    port: dbport
});

//list all custom models that will be loaded
var models = [
    {
        name: "Map", /*What we want to be able to reference the model as in code*/
        file: "map" /*the name of the model file in the same directory as this, doesn't need the .js*/
    },
	{
		name: "Tile2D",
		file: "tile2d"
	}
];

//load models dynamically
models.forEach(function(model) {
    module.exports[model.name] = sequelize.import(__dirname + '/' + model.file); 
});

module.exports.init = function(virt_modules, done) {
	for (var i = 0; i < virt_modules.length; i++) {
		virt_modules[i].loadModels(module.exports);
	}
	(function(model) {
		//define all associations

		
		//Obtain reference to scurvy from a central location
		var scurvy = require('../').Scurvy;
		
		//scurvy associations
		scurvy.setupAssociations(model);

		//custom model associations
		model.User.hasMany(model.Map);
		model.Map.belongsTo(model.User);
		model.Map.hasMany(model.Tile2D);
		model.Tile2D.belongsTo(model.Map);
        
		//ensure tables are created with the fields and associations

		//scurvy tables
		scurvy.setupSync(model, function(err) {
			if (err) { console.log('Error when trying to sync scurvy tables.'); }

			//custom models tables
			model.Map.sync().success(function() {
				model.Tile2D.sync().success(function() {
					//callback
					done();
				}).error(function(error) { console.log("Error during Tile2D.sync(): " + error); });
			}).error(function(error) { console.log("Error during Map.sync(): " + error); });
		});
    })(module.exports);
};

//export the connection
module.exports.sequelize = sequelize;
```

Scurvy follows the sequelize convention for creating models. Any custom model that would integrate with scurvy's models (```User``` and ```Metastate```) would need to follow the sequelize model convention as well. The Tile2D and Map custom models in the example are as follows:

```
/lib/models/Map.js
```

```
module.exports = function(sequelize, DataTypes) {
    var Map = sequelize.define("Map", {
        name: {
            type: DataTypes.STRING(30),
            validate: {
                isAlphanumeric: true
            }
        },
        width_tiles: {
            type: DataTypes.INTEGER(11).UNSIGNED
        },
        height_tiles: {
            type: DataTypes.INTEGER(11).UNSIGNED
        },
        square_size: {
            type: DataTypes.INTEGER(11).UNSIGNED
        }
    }, {
        freezeTableName: true
    });

    return Map;
};
```

```
/lib/models/Tile2D.js
```

```
module.exports = function(sequelize, DataTypes) {
    var Tile2D = sequelize.define("Tile2D", {
        name: {
            type: DataTypes.STRING(30),
            validate: {
                isAlphanumeric: true
            }
        },
        index: {
            type: DataTypes.INTEGER(11).UNSIGNED
        },
        tileset_id: {
            type: DataTypes.INTEGER(11).UNSIGNED
        },
        tile_id: {
            type: DataTypes.INTEGER(11).UNSIGNED
        }
    }, {
        freezeTableName: true
    });

    return Tile2D;
};
```

(in progress, to be continued)
TODO: ```/lib/index.js``` that calls init on ```/lib/models/index.js```

